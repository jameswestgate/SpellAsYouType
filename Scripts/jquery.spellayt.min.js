/*
* Spell As You Type jQuery Plugin v1.3
*
* Copyright (c) 2009 Honda UK (www.honda.co.uk)
* @author James Westgate
* @requires jQuery v1.3.2 or later
*
* Dual licensed under the MIT and GPL licenses:
*   http://www.opensource.org/licenses/mit-license.php
*   http://www.gnu.org/licenses/gpl.html
*
* Dictionary.txt based on the English wordlist created by Kevin Atkinson
* licensed under the LGPL license.
*
*/

(function(w){var d=new Array(26),I=[],C={},g=false,p=false,b=false,t=null,o=[],m=0,G=0,c=0,D=null,i=[],h=0;var u=w(window);w.fn.extend({spellayt:function(K){if(!w.browser.msie){return}if(w.browser.version<6){return}t=w.extend({},w.fn.spellayt.defaults,K);if(!g&&!p){p=true;w.ajax({type:"GET",url:t.url,dataType:"text",success:function(L){E(L);g=true;if(w.fn.spellayt.loaded!=null){w.fn.spellayt.loaded()}p=false;l()},error:function(L,N,M){if(w.fn.spellayt.loadError!=null){w.fn.spellayt.loadError(N)}p=false}})}u.scroll(function(L){w("div.spellayt",this).remove()});u.bind("resize",function(){w("div.spellayt",this).remove()});w("<div style='position:absolute;top:0;left:-10;width:1;height:1'></div>").appendTo(document.body).show();return this.each(function(M){var L='<span style="display:none">.</span>';w(L).insertBefore(this);w(L).insertAfter(this);var N=w(this);N.data("opts",t);N.focus(function(O){D=this;if(g){l()}});N.blur(function(O){if(g){q()}});N.mousedown(function(O){w("div.spellaytMenu").remove()});N.scroll(function(O){y()});N.keydown(function(P){var O=P.keyCode;if(O>=33&&O<=40){return}if(O==27||O==8||O==46||O==13){w("div.spellaytMenu").remove();y();return}y();F(D);b=true});N.bind("contextmenu",function(){return !v(this)})})},spellcheck:function(K){y();t=w.extend({},w.fn.spellayt.defaults,K);return this.each(function(L){if(!g){return}var M=w(this);M.data("opts",t);clearTimeout(m);clearInterval(G);clearInterval(c);b=false;f(this);while(o.length>0){H(o,m,0)}F(this)})},spellclear:function(K){return this.each(function(L){y()})}});w.fn.spellayt.defaults={url:"dictionary.txt",matchSentence:/[^.!?]+/g,matchWord:/[a-zA-Z0-9_]+/g,maximum:12,milliseconds:50,offset:{left:0,top:-4},resources:{ignore:"Ignore All",nosuggest:"No Suggestions"}};w.fn.spellayt.loaded=null;w.fn.spellayt.loadError=null;w.fn.spellayt.ready=function(){return g};w.fn.spellayt.replace=function(K){var L=n();if(L!=null){if(L.text.indexOf(" ")!=-1){K+=" "}L.text=K;j();return true}return false};w.fn.spellayt.ignore=function(){var M=n();if(M!=null){var K=w.trim(M.text);var L=C[K];if(L!=null){L.ignore=true;j();return true}}return false};var y=function(){w(".spellayt").remove()};var l=function(){if(D!=null){c=setInterval(function(){if(o.length==0){f(D)}},500);G=setInterval(function(){y();F(D)},500);H(o,m,t.milliseconds)}};var q=function(){w("div.spellaytMenu").remove();w(".spellayt").remove();clearTimeout(m);clearInterval(G);clearInterval(c)};var F=function(X){if(X==null){return}var R=X.createTextRange();var N=2;var U=w(X);var P=U.data("opts");if(P==null){P=t}var M=u.scrollTop()+U.scrollTop()+P.offset.top;var O=u.scrollLeft()+U.scrollLeft()+P.offset.left-1;var V=U.offset();var Z=V.left+U.width();var L=V.top+U.height();var T=[];for(var Y in C){var Q=C[Y];if(!Q.match&&!Q.ignore){var K=R.duplicate();while(K.findText(Q.term,0,N)){var W=K.boundingLeft+O;var S=K.boundingTop+K.boundingHeight+M;if(S>L){break}if(S>V.top&&W>=V.left&&(W+K.boundingWidth<Z)&&K.compareEndPoints("EndToEnd",R)!=0){T.push("<div id='divWord' class='spellayt' style='top:");T.push(S);T.push("px;left:");T.push(W);T.push("px;width:");T.push(K.boundingWidth);T.push("px'></div>")}K.move("word");K.setEndPoint("EndToEnd",R)}}}if(T.length>0){T.unshift("<div style='position:absolute; z-index:96; left:0px; top: 0px'>");T.push("</div>");w(T.join("")).appendTo(document.body)}};var f=function(L){if(L==null){return}if(!b){var K=B(L.value);if(K==null){return}for(var M=0;M<K.length;M++){o.push({c:function(O){A(O)},d:K[M]})}}else{var N=document.selection.createRange();N.expand("sentence",-1);if(N==null){return}o.push({c:function(O){A(O)},d:N.text})}b=false};var E=function(P){for(var M=0;M<26;M++){d[M]=new Array(13);for(var O=0;O<13;O++){d[M][O]=[]}}var R=P.indexOf("\r\n");var L=0;while(R>-1){var Q=P.substring(L,R);var N=Q.charCodeAt(0);var K=Q.length;if(!isNaN(N)){if(K>13){K=13}if(N>96&&N<123){N-=32}N-=65;if(N>=0&&N<=25){d[N][K-1].push(Q)}}L=R+2;R=P.indexOf("\r\n",L)}P=null};var H=function(K,N,M){if(K.length>0){var L=K.shift();L.c(L.d)}if(M>0){N=setTimeout(function(){H(K,N,M)},M)}};var A=function(L){if(L==null){return}var M=L.match(t.matchWord);if(M==null){return}for(var K=0;K<M.length;K++){o.push({c:function(N){J(N)},d:M[K]})}};var J=function(L){if(I[L]!=null){return}I[L]=true;var K=z(L);if(K<0||K>25){return}if(L.toUpperCase()==L){return}var M={term:L,index:K,alts:null,match:false,ignore:false,ready:false};o.push({c:function(N){a(N)},d:{suggest:M,word:L}})};var a=function(M){var O=M.suggest;var N=M.word;var L=N.length;if(L>13){L=13}O.match=(x(N,d[O.index][L-1])>-1);if(!O.match){var K=N.charCodeAt(0);if(K>64&&K<91){o.push({c:function(P){a(P)},d:{suggest:O,word:N.toLowerCase()}});return}}C[O.term]=O};var r=function(R,V){R.alts=[];for(var Q=0;Q<=4;Q++){R.alts[Q]=[]}var T=d[R.index];var K=R.term;var M=K.substr(1);var S=K.length-1;if(S>12){S=12}if(S==1){var U=(K.charAt(1)+K.charAt(0)).toLowerCase();var N=d[z(U)];if(x(U,N[1])>-1){R.alts[0].push(U)}}if(S>1){var P=K.charCodeAt(0);var O=(P>=65&&P<=91);var W=z(K);for(var Q=0;Q<26;Q++){if(Q!=W){var X=String.fromCharCode(65+Q)+M;var L=String.fromCharCode(97+Q)+M;var U=(O)?X:L;var N=d[Q];if(x(U,N[S])>-1){R.alts[1].push(U)}var U=(!O)?X:L;if(x(U,N[S])>-1){R.alts[2].push(U)}}}}i.push({c:function(Y){k(Y)},d:{word:K,array:T[S],suggest:R}});if(S<12){i.push({c:function(Y){k(Y)},d:{word:K,array:T[S+1],suggest:R}})}if(S>0){i.push({c:function(Y){k(Y)},d:{word:K,array:T[S-1],suggest:R}})}if(S<11){i.push({c:function(Y){k(Y)},d:{word:K,array:T[S+2],suggest:R}})}i.push({c:function(Y){s(Y)},d:{suggest:R,input:V}});H(i,h,5)};var k=function(N){var P=N.word;var R=N.array;var Q=N.suggest;for(var L=0;L<R.length;L++){var K=R[L];var M=e(P,K);if(M==0){Q.alts[0].push(K)}else{var O=Math.floor(P.length/2);if(O<=0){O=1}if(O>4){O=4}if(O>=M){Q.alts[M].push(K)}}}};var s=function(K){K.suggest.ready=true;clearTimeout(h);v(K.input)};var v=function(X){var V=n();if(V!=null){var K=document.selection.createRange();var Y=K.boundingLeft+u.scrollLeft()+w(X).scrollLeft();var W=K.boundingTop+(K.boundingHeight/2)+u.scrollTop()+w(X).scrollTop();var M="top:"+W+"px;left:"+Y+"px;height:auto";var L=w.trim(V.text);var S=C[L];if(S!=null&&!S.match&&!S.ignore){var Q=L.charCodeAt(0);var P=(Q>=65&&Q<=91);clearTimeout(m);clearInterval(G);clearInterval(c);if(!S.ready){r(S,X);return true}var U="<div id='divSuggest' class='spellaytMenu' style='"+M+"'></div>";var Z=w(U).appendTo(document.body);var T=0;for(var R=0;R<S.alts.length;R++){if(R<2||T+S.alts[R].length<=t.maximum){for(var O=0;O<S.alts[R].length;O++){var N=S.alts[R][O].replace("'","&#39;");if(P){N=N.charAt(0).toUpperCase()+N.substr(1)}Z.append("<a class='spellaytMenuItem' href='#' onmousedown='jQuery.fn.spellayt.replace(\""+N+"\");return false;'>"+N+"</a>");T++}}}if(T==0){Z.append("<a class='spellaytMenuItem' href='#' onmousedown='jQuery.fn.spellayt.ignore();return false;'>("+t.resources.nosuggest+")</a>")}Z.append("<div class='spellaytMenuSep'><span style='height:1px'/></div>");Z.append("<a class='spellaytMenuItem' href='#' onmousedown='jQuery.fn.spellayt.ignore();return false;'>"+t.resources.ignore+"</a>");if(w.browser.version==6&&w.fn.bgiframe){Z.bgiframe()}Z.show();return true}}return false};var B=function(O){var L=O.match(t.matchSentence);var K=[];if(L==null){return}for(var M=0;M<L.length;M++){var N=L[M];if(N!=null){N=w.trim(N);K.push(N)}}return K};var j=function(){setTimeout(function(){D.focus();y();F(D)},200)};var e=function(W,V){var S=[];var K=W.length;var M=V.length;if(K==0){return M}if(M==0){return K}for(var P=K;P>=0;P--){S[P]=[]}for(var P=K;P>=0;P--){S[P][0]=P}for(var O=M;O>=0;O--){S[0][O]=O}for(var P=1;P<=K;P++){var N=W.charAt(P-1);for(var O=1;O<=M;O++){if(P==O&&S[P][O]>4){return K}var R=V.charAt(O-1);var L=(N==R)?0:1;var Q=S[P-1][O]+1;var U=S[P][O-1]+1;var T=S[P-1][O-1]+L;if(U<Q){Q=U}if(T<Q){Q=T}S[P][O]=Q;if(P>1&&O>1&&N==V.charAt(O-2)&&W.charAt(P-2)==R){S[P][O]=Math.min(S[P][O],S[P-2][O-2]+L)}}}return S[K][M]};var z=function(L){var K=L.charCodeAt(0);if(K>96&&K<123){K-=32}K-=65;return K};var n=function(){var K=document.selection.createRange();K.expand("word");if(K.text=="."){K=document.selection.createRange();K.moveStart("word",-1);K.moveEnd("sentence");K.moveEnd("character",-2)}return K};var x=function(N,M){var L=0;var P=M.length-1;while(L<=P){var O=parseInt((L+P)/2,10);var K=M[O];if(K===N){return O}else{if(K<N){L=O+1}else{P=O-1}}}return -1}})(jQuery);